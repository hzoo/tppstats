function makeWithConcat(a){var b,c,d;if(0===a)return[];for(b=[0],d=1;a>d;)c=a-d,b=b.concat(d>c?b.slice(0,c):b),d=b.length;return b}function getParameterByName(a){a=a.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var b=new RegExp("[\\?&]"+a+"=([^&#]*)"),c=b.exec(location.search);return null===c?"":decodeURIComponent(c[1].replace(/\+/g," "))}function command(a){var b=!0,c=[];return context.metric(function(d,e,f,g){if(b){var h=realTimeData[keymap[a]];b=!1,c=makeWithConcat(graphSize-h.length),c=c.concat(h),g(null,c=c.slice((d-e)/f))}else c=realTimeData[keymap[a]],g(null,c=c.slice((d-e)/f))},a)}function changeScale(a){window.location.search="step="+a.value}function startGraph(){var a=command("anarchy");d3.select("#demo1").call(function(b){b.append("div").attr("class","axis").call(context.axis().orient("top")),b.selectAll(".horizon").data([a]).enter().append("div").attr("class","horizon").call(context.horizon().height(60).colors([0].concat(colorbrewer.Purples[3]))),b.append("div").attr("class","rule").call(context.rule())}),d3.select("#demo2").call(function(a){a.selectAll(".horizon").data(commandList.map(command)).enter().append("div").attr("class","horizon").call(context.horizon().height(60).colors(function(){return[0].concat(colorbrewer.Purples[3])}))})}function resetCounts(){return{a:0,b:0,u:0,l:0,r:0,d:0,s:0,e:0,n:0,m:0}}function addToCommands(a){counts[a]++,queue.push(a),queue.length>=queueLength&&counts[queue.shift()]--}function processLastData(a){addToCommands(a)}function pad(a,b){for(a=a.toString();a.length<b;)a=" "+a;return a}function animate(){ctx.save(),ctx.setTransform(1,0,0,1,0,0),ctx.clearRect(0,0,canvas.width,canvas.height),ctx.restore();var a=counts.a,b=counts.b,c=counts.u,d=counts.d,e=counts.l,f=counts.r,g=counts.s,h=counts.n,i=c+d+e+f;ctx.globalAlpha=.25,ctx.lineWidth=.5,ctx.strokeStyle="#AAA";var j=100.5;ctx.moveTo(j,.5),ctx.lineTo(j,200.5),ctx.moveTo(.5,j),ctx.lineTo(200.5,j),ctx.stroke(),ctx.strokeStyle="#000",ctx.lineWidth=.5,ctx.fillStyle="#EEE";var k=3;ctx.moveTo(j,j-c*k),ctx.lineTo(j+f*k,j),ctx.lineTo(j,j+d*k),ctx.lineTo(j-e*k,j),ctx.lineTo(j,j-c*k),ctx.stroke(),ctx.fill(),ctx.globalAlpha=1,ctx.fillStyle=colorbrewer.Purples[3][2],ctx.beginPath();var l=250.5,m=60.5;ctx.fillRect(l,m,a,5),ctx.fillRect(l,m+15,b,5),ctx.fillRect(l,m+30,g,5),ctx.fillRect(l,m+45,h,5),ctx.fillRect(l,m+60,i,5),ctx.font="10px Arial",ctx.fillText("A",l-35,m+5),ctx.fillText("B",l-35,m+5+15),ctx.fillText("STAR",l-35,m+5+30),ctx.fillText("ANAR",l-35,m+5+45),ctx.fillText("DPAD",l-35,m+5+60),ctx.fillText(pad(a,2),l+117,m+5),ctx.fillText(pad(b,2),l+117,m+5+15),ctx.fillText(pad(g,2),l+117,m+5+30),ctx.fillText(pad(h,2),l+117,m+5+45),ctx.fillText(pad(i,2),l+117,m+5+60),ctx.fill();var n=Math.atan2((f-e)/2,(d-c)/2);ctx.strokeStyle="#000",ctx.lineWidth=1,ctx.beginPath(),ctx.fillStyle="#b2b2b2",ctx.fillText("AVG direction of AJ",50.5,140.5),ctx.fill(),ctx.beginPath(),ctx.fillStyle="#555",ctx.fillText("last 100 keys",l+25,m-15),ctx.fill();var o=Math.sqrt((f-e)*(f-e)+(c-d)*(c-d));4>o&&(o=4);var p=100.5,q=100.5;ctx.strokeStyle="#E82C0C",ctx.moveTo(p,q),ctx.lineTo(p+Math.sin(n)*o,q+Math.cos(n)*o),ctx.stroke(),ctx.beginPath(),ctx.strokeStyle="#bdbdbd",ctx.moveTo(p,q),ctx.lineTo(p+100*Math.sin(n),q+100*Math.cos(n)),ctx.stroke(),ctx.beginPath();var r=.1,s=3,t=27;ctx.strokeStyle="#000",ctx.lineTo(p+Math.sin(n-r)*Math.max(o-s,t),q+Math.cos(n-r)*Math.max(o-s,t)),ctx.lineTo(p+Math.sin(n+r)*Math.max(o-s,t),q+Math.cos(n+r)*Math.max(o-s,t)),ctx.lineTo(p+Math.sin(n)*Math.max(o,t+s),q+Math.cos(n)*Math.max(o,t+s)),ctx.fill(),ctx.stroke(),showGraph===!0&&window.requestAnimationFrame(animate)}if("localhost"===location.host.split(":")[0])var socket=io.connect("http://localhost:8080");else var socket=io.connect(location.host);for(var realTimeData={a:[],b:[],u:[],l:[],r:[],d:[],s:[],e:[],n:[],m:[],w:[]},commands=["a","b","u","l","r","d","s","e","n","m","w"],graphSize=720,queueLength=graphSize,keymap={up:"u",left:"l",down:"d",right:"r",a:"a",b:"b",democracy:"m",anarchy:"n",start:"s",select:"e",wait:"w"},commandList=["up","down","left","right","a","b","start"],step=Number(getParameterByName("step"))||1e4,context=cubism.context().serverDelay(100).clientDelay(0).step(step).size(graphSize),granularities={1e3:"1second",5e3:"5seconds",1e4:"10seconds",3e4:"30seconds",6e4:"1minute",3e5:"5minutes"},sel=document.querySelector("select"),j=0;j<sel.options.length;j++){var i=sel.options[j];if(Number(i.value)===Number(getParameterByName("step"))){sel.selectedIndex=j;break}}context.on("focus",function(a){d3.selectAll(".value").style("right",null===a?null:context.size()-a+"px")}),socket.emit("graphInfo",{step:granularities[step.toString()]}),socket.on("realtime",function(a){for(var b=0;b<a.length;b++)realTimeData[commands[b]].length>=queueLength&&realTimeData[commands[b]].shift(),realTimeData[commands[b]].push(a[b][0])}),socket.on("history",function(a){for(var b=0;b<a.length;b++)realTimeData[commands[b]]=a[b];startGraph()}),function(){var a=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(a,1e3/60)};window.requestAnimationFrame=a}();var counts=resetCounts(),canvas=document.querySelector("canvas"),ctx=canvas.getContext("2d"),queue=[],queueLength=100;socket.on("cmd",function(a){processLastData(a)}),socket.on("cb",function(a){for(var b=0;b<Math.min(a.length,queueLength);b++)addToCommands(a[b])});var showGraph=!0;document.getElementById("toggleButton").onclick=function(){showGraph=showGraph?!1:!0,showGraph?(canvas.style.display="block",animate()):canvas.style.display="none"},animate();