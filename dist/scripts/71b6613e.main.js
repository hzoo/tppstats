function makeWithConcat(len){var a,rem,currlen;if(0===len)return[];for(a=[0],currlen=1;len>currlen;)rem=len-currlen,a=a.concat(currlen>rem?a.slice(0,rem):a),currlen=a.length;return a}function getParameterByName(name){name=name.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var regex=new RegExp("[\\?&]"+name+"=([^&#]*)"),results=regex.exec(location.search);return null===results?"":decodeURIComponent(results[1].replace(/\+/g," "))}function command(name){var firstTime=!0,values=[];return context.metric(function(start,stop,step,callback){if(firstTime){var data=realTimeData[keymap[name]];firstTime=!1,values=makeWithConcat(graphSize-data.length),values=values.concat(data),callback(null,values=values.slice((start-stop)/step))}else values=realTimeData[keymap[name]],callback(null,values=values.slice((start-stop)/step))},name)}function changeScale(sel){window.location.search="step="+sel.value}function startGraph(){d3.select("#demo1").call(function(div){div.append("div").attr("class","axis").call(context.axis().orient("top")),div.selectAll(".horizon").data([demo.subtract(anar)]).enter().append("div").attr("class","horizon").call(context.horizon().height(60).extent([-15,15].map(function(d){return d*step/1e3/4})).colors(["#6baed6","#bdd7e7","#bae4b3","#74c476"])),div.append("div").attr("class","rule").call(context.rule())}),d3.select("#demo2").call(function(div){div.selectAll(".horizon").data(commandList.map(command)).enter().append("div").attr("class","horizon").call(context.horizon().height(60).extent([0,60].map(function(d){return d*step/1e3/8})).colors(["#6baed6","#bdd7e7","#bae4b3","#74c476"]))});var up=command("up"),down=command("down"),left=command("left"),right=command("right"),dpad=up.add(down).add(left).add(right),vertical=up.subtract(down),horizontal=right.subtract(left);d3.select("#demo3").call(function(div){div.selectAll(".horizon").data([dpad]).enter().append("div").attr("class","horizon").call(context.horizon().height(60).extent([0,100].map(function(d){return d*step/1e3/8})).colors(["#6baed6","#bdd7e7","#bae4b3","#74c476"]).title("dpad"))}),d3.select("#demo4").call(function(div){div.selectAll(".horizon").data([vertical,horizontal]).enter().append("div").attr("class","horizon").call(context.horizon().height(60).extent([-30,30].map(function(d){return d*step/1e3/8})).colors(["#6baed6","#bdd7e7","#bae4b3","#74c476"]).title(function(d,i){return 0===i?"vertical":1===i?"horizontal":void 0}))})}if("localhost"===location.host.split(":")[0])var socket=io.connect("http://localhost:8080");else var socket=io.connect(location.host);for(var realTimeData={a:[],b:[],u:[],l:[],r:[],d:[],s:[],e:[],n:[],m:[]},commands=["a","b","u","l","r","d","s","e","n","m"],graphSize=720,queueLength=graphSize,keymap={up:"u",left:"l",down:"d",right:"r",a:"a",b:"b",democracy:"m",anarchy:"n",start:"s",select:"e"},commandList=["start","a","b","up","down","left","right"],step=Number(getParameterByName("step"))||1e4,context=cubism.context().serverDelay(100).clientDelay(0).step(step).size(graphSize),demo=command("democracy"),anar=command("anarchy"),granularities={1e4:"10seconds",3e4:"30seconds",6e4:"1minute",6e5:"10minutes",18e5:"30minutes",36e5:"1hour"},sel=document.querySelector("select"),j=0;j<sel.options.length;j++){var i=sel.options[j];if(i.value===Number(getParameterByName("step"))){sel.selectedIndex=j;break}}context.on("focus",function(i){d3.selectAll(".value").style("right",null===i?null:context.size()-i+"px")}),socket.emit("graphInfo",{step:granularities[step.toString()]}),socket.on("realtime",function(data){for(var i=0;i<data.length;i++)realTimeData[commands[i]].length>=queueLength&&realTimeData[commands[i]].shift(),realTimeData[commands[i]].push(data[i][0])}),socket.on("history",function(data){for(var i=0;i<data.length;i++)realTimeData[commands[i]]=data[i];startGraph()});