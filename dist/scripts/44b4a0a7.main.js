function makeWithConcat(a){var b,c,d;if(0===a)return[];for(b=[0],d=1;a>d;)c=a-d,b=b.concat(d>c?b.slice(0,c):b),d=b.length;return b}function getParameterByName(a){a=a.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var b=new RegExp("[\\?&]"+a+"=([^&#]*)"),c=b.exec(location.search);return null===c?"":decodeURIComponent(c[1].replace(/\+/g," "))}function command(a){var b=!0,c=[];return context.metric(function(d,e,f,g){if(b){var h=realTimeData[keymap[a]];b=!1,c=makeWithConcat(graphSize-h.length),c=c.concat(h),g(null,c=c.slice((d-e)/f))}else c=realTimeData[keymap[a]],g(null,c=c.slice((d-e)/f))},a)}function changeScale(a){window.location.search="step="+a.value}function startGraph(){var a=command("up"),b=command("down"),c=command("left"),d=command("right"),e=command("start"),f=a.add(b).add(c).add(d),g=command("a"),h=command("b"),i=g.add(h);d3.select("#demo1").call(function(a){a.append("div").attr("class","axis").call(context.axis().orient("top")),a.selectAll(".horizon").data([f.add(i).add(e)]).enter().append("div").attr("class","horizon").call(context.horizon().height(30).colors([0].concat(colorbrewer.Purples[3])).title(function(a,b){return 0===b?"all keys":"mag"})),a.append("div").attr("class","rule").call(context.rule())}),d3.select("#demo2").call(function(a){a.selectAll(".horizon").data(commandList.map(command)).enter().append("div").attr("class","horizon").call(context.horizon().height(60).colors(function(){return[0].concat(colorbrewer.Purples[3])}))})}function resetCounts(){return{a:0,b:0,u:0,l:0,r:0,d:0,s:0,e:0,n:0,m:0}}function addToCommands(a){counts[a]++,queue.push(a),queue.length>=queueLength&&counts[queue.shift()]--}function processLastData(a){addToCommands(a)}function pad(a,b){for(a=a.toString();a.length<b;)a=" "+a;return a}function getDir(a,b){return a>-b&&b>a?"SOUTH":a>Math.PI/2-b&&a<Math.PI/2+b?"EAST":a>Math.PI-b&&a<-Math.PI+b?"NORTH":a>-Math.PI/2-b&&a<-Math.PI/2+b?"WEST":a>0&&a<Math.PI/2?"SOUTH EAST":a>Math.PI/2&&a<Math.PI?"NORTH EAST":a>-Math.PI/2&&0>a?"SOUTH WEST":"NORTH WEST"}function animate(){ctx.save(),ctx.setTransform(1,0,0,1,0,0),ctx.clearRect(0,0,canvas.width,canvas.height),ctx.restore();var a=counts.a,b=counts.b,c=counts.u,d=counts.d,e=counts.l,f=counts.r,g=counts.s,h=c+d+e+f;ctx.globalAlpha=.25,ctx.lineWidth=.5,ctx.strokeStyle="#AAA";var i=100.5;ctx.moveTo(i,.5),ctx.lineTo(i,200.5),ctx.moveTo(.5,i),ctx.lineTo(200.5,i),ctx.stroke(),ctx.strokeStyle="#000",ctx.lineWidth=.5,ctx.fillStyle="#EEE";var j=3;ctx.moveTo(i,i-c*j),ctx.lineTo(i+f*j,i),ctx.lineTo(i,i+d*j),ctx.lineTo(i-e*j,i),ctx.lineTo(i,i-c*j),ctx.stroke(),ctx.fill(),ctx.globalAlpha=1,ctx.fillStyle=colorbrewer.Purples[3][2],ctx.beginPath();var k=250.5,l=60.5;ctx.fillRect(k,l,a,5),ctx.fillRect(k,l+15,b,5),ctx.fillRect(k,l+30,g,5),ctx.fillRect(k,l+45,h,5),ctx.font="10px Arial",ctx.fillText("A",k-35,l+5),ctx.fillText("B",k-35,l+5+15),ctx.fillText("STAR",k-35,l+5+30),ctx.fillText("DPAD",k-35,l+5+45),ctx.fillText(pad(a,2),k+117,l+5),ctx.fillText(pad(b,2),k+117,l+5+15),ctx.fillText(pad(g,2),k+117,l+5+30),ctx.fillText(pad(h,2),k+117,l+5+45),ctx.fill();var m=Math.atan2((f-e)/2,(d-c)/2);ctx.strokeStyle="#000",ctx.lineWidth=1,ctx.beginPath(),ctx.fillText("AVG DIR: "+getDir(m,getDirMargin),56,152),ctx.fill(),ctx.beginPath(),ctx.fillStyle="#555",ctx.fillText("last 100 keys",k+25,l-15),ctx.fill();var n=Math.sqrt((f-e)*(f-e)+(c-d)*(c-d));ctx.beginPath(),ctx.fillText("MAG: "+Math.floor(n),74,168),ctx.fill();var o=100.5,p=100.5;ctx.strokeStyle="#e0e0e0",ctx.moveTo(o,p),ctx.lineTo(o+100*Math.sin(m),p+100*Math.cos(m)),ctx.stroke(),ctx.beginPath(),ctx.strokeStyle="#E82C0C",ctx.moveTo(o,p),ctx.lineTo(o+Math.sin(m)*n,p+Math.cos(m)*n),ctx.stroke(),ctx.beginPath();var q=.1,r=3,s=27;ctx.strokeStyle="#000",ctx.lineTo(o+Math.sin(m-q)*Math.max(n-r,s),p+Math.cos(m-q)*Math.max(n-r,s)),ctx.lineTo(o+Math.sin(m+q)*Math.max(n-r,s),p+Math.cos(m+q)*Math.max(n-r,s)),ctx.lineTo(o+Math.sin(m)*Math.max(n,s+r),p+Math.cos(m)*Math.max(n,s+r)),ctx.fill(),ctx.stroke(),showGraph===!0&&window.requestAnimationFrame(animate)}function addStream(){streamAdded=!0,swfobject.embedSWF("//www-cdn.jtvnw.net/swflibs/TwitchPlayer.swf","twitch_embed_player","720","480","11",null,{eventsCallback:"onPlayerEvent",embed:1,channel:"twitchplayspokemon",auto_play:"true"},{allowScriptAccess:"always",allowFullScreen:"true"})}if("localhost"===location.host.split(":")[0])var socket=io.connect("http://localhost:8080");else var socket=io.connect(location.host);for(var realTimeData={a:[],b:[],u:[],l:[],r:[],d:[],s:[],e:[],n:[],m:[]},commands=["a","b","u","l","r","d","s","e","n","m"],graphSize=720,queueLength=graphSize,keymap={up:"u",left:"l",down:"d",right:"r",a:"a",b:"b",democracy:"m",anarchy:"n",start:"s",select:"e"},commandList=["up","down","left","right","a","b","start"],step=Number(getParameterByName("step"))||1e4,context=cubism.context().serverDelay(100).clientDelay(0).step(step).size(graphSize),granularities={1e3:"1second",5e3:"5seconds",1e4:"10seconds",3e4:"30seconds",6e4:"1minute",3e5:"5minutes"},sel=document.getElementById("timeIntervalSelect"),j=0;j<sel.options.length;j++){var i=sel.options[j];if(Number(i.value)===Number(getParameterByName("step"))){sel.selectedIndex=j;break}}context.on("focus",function(a){d3.selectAll(".value").style("right",null===a?null:context.size()-a+"px")}),socket.emit("graphInfo",{step:granularities[step.toString()]}),socket.on("realtime",function(a){for(var b=0;b<a.length;b++)realTimeData[commands[b]]&&realTimeData[commands[b]].length>=queueLength&&realTimeData[commands[b]].shift(),realTimeData[commands[b]].push(a[b][0])}),socket.on("history",function(a){for(var b=0;b<a.length;b++)realTimeData[commands[b]]=a[b];startGraph()}),function(){var a=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(a,1e3/60)};window.requestAnimationFrame=a}();var counts=resetCounts(),canvas=document.querySelector("canvas"),ctx=canvas.getContext("2d"),queue=[],queueLength=100;socket.on("cmd",function(a){processLastData(a)}),socket.on("cb",function(a){for(var b=0;b<Math.min(a.length,queueLength);b++)addToCommands(a[b])});var getDirMargin=Math.PI/90,showGraph=!0;document.getElementById("toggleGraph").onclick=function(){showGraph=showGraph?!1:!0,showGraph?(canvas.style.display="block",animate()):canvas.style.display="none"};var twitchPlayer,twitchNumViewers;window.onPlayerEvent=function(a){a.forEach(function(a){"playerInit"===a.event&&(twitchPlayer=document.getElementById("twitch_embed_player"),twitchPlayer.playVideo()),"viewerCount"===a.event&&(twitchNumViewers=a.data.viewers,console.log(twitchNumViewers))})};var streamAdded=!1;window.innerWidth>1460&&addStream();var showStream=!0;document.getElementById("toggleStream").onclick=function(){showStream=!showStream,showStream===!0?(twitchPlayer.style.display="block",twitchPlayer.playVideo()):showStream===!1&&(streamAdded?(twitchPlayer.pauseVideo(),twitchPlayer.style.display="none"):(showStream=!showStream,addStream()))},animate();